version: 2.1

commands:
  setup:
    steps:
      - run:
          name: 'CI Setup'
          command: |
            ./dev ci-setup

jobs:
  x64-test:
    docker:
      - image: fedora:38
    steps:
      - checkout
      - setup
      - run:
          name: 'Create test output directory'
          command: mkdir -p /tmp/gtest_output
      - run:
          name: 'Run tests'
          command: >-
            bazel test
            --config=dbg
            --test_arg="--gtest_output=xml:/tmp/gtest_output"
            --test_output=errors
            //...
      - store_test_results:
          path: /tmp/gtest_output
  arm64-test:
    machine:
      image: ubuntu-2204:current
    resource_class: arm.medium
    steps:
      - checkout
      - setup
      - run:
          name: 'Create test output directory'
          command: mkdir -p /tmp/gtest_output
      - run:
          name: 'Run tests'
          # We don't run with ubsan mode because of clang linking bugs:
          # See: https://github.com/envoyproxy/envoy/issues/13973
          command: >-
            bazel test
            --config=asan
            --test_arg="--gtest_output=xml:/tmp/gtest_output"
            --test_output=errors
            //...
      - store_test_results:
          path: /tmp/gtest_output

workflows:
  wasmcc:
    jobs:
      - x64-test
      - arm64-test
